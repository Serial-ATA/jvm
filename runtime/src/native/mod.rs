#![allow(non_snake_case)]

mod lib;

use crate::reference::Reference;
use crate::stack::local_stack::LocalStack;
use crate::thread::ThreadRef;

use std::collections::HashMap;
use std::fmt::{Debug, Formatter};
use std::sync::RwLock;

use common::int_types::u1;
use instructions::Operand;
use once_cell::sync::Lazy;

#[derive(Copy, Clone, Eq, Hash, PartialEq)]
pub struct NativeMethodDef<'a> {
	pub class: &'a [u1],
	pub name: &'a [u1],
	pub descriptor: &'a [u1],
}

impl<'a> Debug for NativeMethodDef<'a> {
	fn fmt(&self, f: &mut Formatter<'_>) -> std::fmt::Result {
		f.debug_struct("NativeMethodDef")
			.field("class", &unsafe {
				std::str::from_utf8_unchecked(self.class)
			})
			.field("name", &unsafe { std::str::from_utf8_unchecked(self.name) })
			.field("descriptor", &unsafe {
				std::str::from_utf8_unchecked(self.descriptor)
			})
			.finish()
	}
}

pub struct JNIEnv {
	pub current_thread: ThreadRef,
}

pub type NativeReturn = Option<Operand<Reference>>;
pub type NativeMethodPtr = fn(JNIEnv, LocalStack) -> NativeReturn;

include!("native_init.rs"); // Provides `init_native_method_table()`, generated by `runtime/build.rs`
pub(self) static NATIVE_METHOD_TABLE: Lazy<
	RwLock<HashMap<NativeMethodDef<'static>, NativeMethodPtr>>,
> = Lazy::new(|| RwLock::new(init_native_method_table()));

pub fn lookup_method(def: NativeMethodDef<'_>) -> NativeMethodPtr {
	NATIVE_METHOD_TABLE.read().unwrap()[&def]
}

pub(self) fn insert_method((def, ptr): (NativeMethodDef<'static>, NativeMethodPtr)) {
	NATIVE_METHOD_TABLE.write().unwrap().insert(def, ptr);
}

// Module marker, do not remove
pub(crate) mod jdk {
	pub(crate) mod internal {
		pub(crate) mod misc {
			pub(crate) mod CDS;
			pub(crate) mod VM;
			pub(crate) mod Unsafe;
		}
		pub(crate) mod util {
		pub(crate) mod SystemProps;
		}
		pub(crate) mod reflect {
		pub(crate) mod Reflection;
		}
	}
}

pub(crate) mod java {
	pub(crate) mod lang {
		pub(crate) mod Throwable;
		pub(crate) mod Float;
		pub(crate) mod StringUTF16;
		pub(crate) mod Class;
		pub(crate) mod Double;
		pub(crate) mod System;
		pub(crate) mod Runtime;
		pub(crate) mod Object;
	}
}

